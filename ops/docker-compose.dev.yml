services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"

  surrealdb:
    image: surrealdb/surrealdb:v2
    environment:
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
      - SURREAL_DISABLE_ENV_CHECK=true
    command: >
      start
      --log info
      --username ${SURREALDB_USER:-root}
      --password ${SURREALDB_PASS:-root}
      --bind 0.0.0.0:8000
    ports:
      - "8000:8000"

  redis:
    image: redis:8
    ports:
      - "6379:6379"

  mnemo-api:
    build:
      context: ..
      dockerfile: backend/bin/mnemo-api/Dockerfile
    pull_policy: build
    image: mnemo-api-service:latest
    environment:
      - SURREALDB_URL=${SURREALDB_URL:-http://surrealdb:8000}
      - SURREALDB_RPC_URL=${SURREALDB_RPC_URL:-ws://surrealdb:8000}
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
      - SURREALDB_NS=${SURREALDB_NS:-mnemo}
      - SURREALDB_DB=${SURREALDB_DB:-mnemo}
      - DATABASE_URL=${DATABASE_URL:-postgres://mnemo:mnemo@postgres:5432/mnemo}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - MNEMO_LLM_PROVIDER=${MNEMO_LLM_PROVIDER:-tensorzero}
      - MNEMO_LLM_URL=${MNEMO_LLM_URL:-http://tensorzero:3000}
      - MNEMO_LLM_API_KEY=${MNEMO_LLM_API_KEY:-none}
      - MNEMO_LLM_MODEL=${MNEMO_LLM_MODEL:-chat_default}
      - TENSORZERO_EMBED_MODEL=${TENSORZERO_EMBED_MODEL:-vector_default}
      - TENSORZERO_EMBED_FALLBACK_URL=${TENSORZERO_EMBED_FALLBACK_URL:-http://host.docker.internal:11434}
      - TENSORZERO_EMBED_FALLBACK_MODELS=${TENSORZERO_EMBED_FALLBACK_MODELS:-qwen3-embedding:8b}
      - INGESTION_ROOT=/mnt/host_downloads
      # Default to info; raise to debug/trace locally by exporting RUST_LOG before compose.
      - RUST_LOG=${RUST_LOG:-info}
    ports:
      - "7700:7700"
    volumes:
      - /Users/tkolodchyn/Downloads:/mnt/host_downloads

  postgres:
    image: postgres:18
    restart: always
    environment:
      POSTGRES_USER: mnemo
      POSTGRES_PASSWORD: mnemo
      POSTGRES_DB: mnemo
      # Use cluster-style layout; mount /var/lib/postgresql (not /data) to avoid version upgrade warnings.
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mnemo -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  tensorzero:
    image: tensorzero/gateway:2025.11.6
    restart: unless-stopped
    command: --config-file /app/config/tensorzero.toml --log-format json
    volumes:
      - ./tensorzero-config:/app/config:ro
    ports:
      - "3000:3000"
    environment:
      - TENSORZERO_POSTGRES_URL=postgres://mnemo:mnemo@postgres:5432/tensorzero
      - TENSORZERO_CLICKHOUSE_URL=http://tensorzero:tensorzero@clickhouse:8123/tensorzero
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: wget --spider --tries 1 http://localhost:3000/status
      interval: 15s
      timeout: 1s
      retries: 2
    depends_on:
      tensorzero-db-init:
        condition: service_completed_successfully
      tensorzero-migrate:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy

  tensorzero-db-init:
    image: postgres:18
    command:
      - sh
      - -c
      - >
        psql -h postgres -U mnemo -tc "SELECT 1 FROM pg_database WHERE datname='tensorzero'"
        | grep -q 1
        || psql -h postgres -U mnemo -c "CREATE DATABASE tensorzero"
    environment:
      - PGPASSWORD=mnemo
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  tensorzero-migrate:
    image: tensorzero/gateway:2025.11.6
    command: --run-postgres-migrations
    restart: "no"
    environment:
      - TENSORZERO_POSTGRES_URL=postgres://mnemo:mnemo@postgres:5432/tensorzero
    depends_on:
      postgres:
        condition: service_healthy
      tensorzero-db-init:
        condition: service_completed_successfully

  tensorzero-ui:
    image: tensorzero/ui
    container_name: tensorzero-ui
    restart: unless-stopped
    volumes:
      - ./tensorzero-config:/app/config:ro
    environment:
      - TENSORZERO_GATEWAY_URL=http://tensorzero:3000
      - TENSORZERO_POSTGRES_URL=postgres://mnemo:mnemo@postgres:5432/tensorzero
      - TENSORZERO_CLICKHOUSE_URL=http://tensorzero:tensorzero@clickhouse:8123/tensorzero_ui
      # Enable read-only mode if desired:
      # - TENSORZERO_UI_READ_ONLY=1
      # For local testing against OpenAI, set:
      # - ENABLE_TEST_WITH_OPENAI_API=true
      # - OPENAI_API_KEY=your_key
    ports:
      - "4000:4000"
    depends_on:
      - tensorzero
      - postgres
      - clickhouse

  clickhouse:
    image: clickhouse:lts
    container_name: clickhouse
    restart: unless-stopped
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    ports:
      - "8123:8123"
    environment:
      - CLICKHOUSE_DB=tensorzero_ui
      - CLICKHOUSE_USER=tensorzero
      - CLICKHOUSE_PASSWORD=tensorzero
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    healthcheck:
      test: wget --spider --tries 1 http://tensorzero:tensorzero@clickhouse:8123/ping
      start_period: 30s
      start_interval: 1s
      timeout: 1s  
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

volumes:
  postgres_data:
  clickhouse-data:
