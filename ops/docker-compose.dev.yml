services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"

  surrealdb:
    image: surrealdb/surrealdb:v2
    environment:
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
    command: >
      start --log debug --user ${SURREALDB_USER:-root} --pass ${SURREALDB_PASS:-root} memory
    ports:
      - "8000:8000"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  mnemo-api:
    build:
      context: ..
      dockerfile: backend/bin/mnemo-api/Dockerfile
    pull_policy: build
    image: mnemo-api-service:latest
    environment:
      - SURREALDB_URL=${SURREALDB_URL:-http://surrealdb:8000}
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
      - DATABASE_URL=${DATABASE_URL:-postgres://mnemo:mnemo@postgres:5432/mnemo}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - INGESTION_ROOT=/mnt/host_downloads
    ports:
      - "7700:7700"
    volumes:
      - /Users/tkolodchyn/Downloads:/mnt/host_downloads

  postgres:
    image: postgres:18
    restart: always
    environment:
      POSTGRES_USER: mnemo
      POSTGRES_PASSWORD: mnemo
      POSTGRES_DB: mnemo
      # Use cluster-style layout; mount /var/lib/postgresql (not /data) to avoid version upgrade warnings.
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql

volumes:
  postgres_data:
