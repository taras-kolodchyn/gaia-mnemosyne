services:
  qdrant:
    image: qdrant/qdrant
    ports:
      - "6333:6333"

  surrealdb:
    image: surrealdb/surrealdb:v2
    environment:
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
      - SURREAL_DISABLE_ENV_CHECK=true
    command: >
      start
      --log info
      --username ${SURREALDB_USER:-root}
      --password ${SURREALDB_PASS:-root}
      --bind 0.0.0.0:8000
    ports:
      - "8000:8000"

  redis:
    image: redis:8
    ports:
      - "6379:6379"

  mnemo-api:
    build:
      context: ..
      dockerfile: backend/bin/mnemo-api/Dockerfile
    pull_policy: build
    image: mnemo-api-service:latest
    environment:
      - SURREALDB_URL=${SURREALDB_URL:-http://surrealdb:8000}
      - SURREALDB_RPC_URL=${SURREALDB_RPC_URL:-ws://surrealdb:8000}
      - SURREALDB_USER=${SURREALDB_USER:-root}
      - SURREALDB_PASS=${SURREALDB_PASS:-root}
      - SURREALDB_NS=${SURREALDB_NS:-mnemo}
      - SURREALDB_DB=${SURREALDB_DB:-mnemo}
      - DATABASE_URL=${DATABASE_URL:-postgres://mnemo:mnemo@postgres:5432/mnemo}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - INGESTION_ROOT=/mnt/host_downloads
      # Default to info; raise to debug/trace locally by exporting RUST_LOG before compose.
      - RUST_LOG=${RUST_LOG:-info}
    ports:
      - "7700:7700"
    volumes:
      - /Users/tkolodchyn/Downloads:/mnt/host_downloads

  postgres:
    image: postgres:18
    restart: always
    environment:
      POSTGRES_USER: mnemo
      POSTGRES_PASSWORD: mnemo
      POSTGRES_DB: mnemo
      # Use cluster-style layout; mount /var/lib/postgresql (not /data) to avoid version upgrade warnings.
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql

volumes:
  postgres_data:
